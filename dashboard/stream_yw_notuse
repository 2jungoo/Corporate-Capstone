import streamlit as st
import pandas as pd
import sqlalchemy
import requests
import plotly.express as px
from datetime import datetime

# -----------------------------------------------------------------
# 1) DB ì—°ê²° (secrets.toml ì—†ìœ¼ë©´ ì¡°ìš©íˆ ë¹„í™œì„±)
# -----------------------------------------------------------------
def get_db_connection():
    try:
        db_info = st.secrets["database"]
        engine_url = (
            f"mysql+mysqlconnector://{db_info['user']}:{db_info['password']}@"
            f"{db_info['host']}:{db_info['port']}/{db_info['db_name']}"
        )
        engine = sqlalchemy.create_engine(engine_url, pool_pre_ping=True)
        return engine
    except Exception:
        st.info("DB ë¹„ì‚¬ìš© ëª¨ë“œ: .streamlit/secrets.tomlì˜ [database] ì„¤ì •ì´ ì—†ê±°ë‚˜ ì—°ê²° ì‹¤íŒ¨")
        return None

@st.cache_resource
def init_db_connection():
    return get_db_connection()


# -----------------------------------------------------------------
# 2) ë°ì´í„° ë¡œë“œ & ë‚ ì”¨
# -----------------------------------------------------------------
@st.cache_data(ttl=600)
def load_data_from_db(_engine, table_name, limit=1000, order_by_col="timestamp"):
    if _engine is None:
        return pd.DataFrame()
    try:
        order_clause = f"ORDER BY {order_by_col} DESC" if order_by_col else ""
        limit_clause = f"LIMIT {limit}" if limit else ""
        query = f"SELECT * FROM {table_name} {order_clause} {limit_clause}"
        df = pd.read_sql(query, con=_engine)
        if "timestamp" in df.columns:
            df["timestamp"] = pd.to_datetime(df["timestamp"])
        return df
    except Exception as e:
        st.error(f"'{table_name}' ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: {e}")
        return pd.DataFrame()

@st.cache_data(ttl=3600)
def get_weather_forecast():
    url = "https://api.open-meteo.com/v1/forecast"
    params = {
        "latitude": 37.5665,
        "longitude": 126.9780,
        "daily": "precipitation_probability_max",
        "timezone": "Asia/Seoul",
    }
    try:
        r = requests.get(url, params=params, timeout=5)
        r.raise_for_status()
        data = r.json()
        return pd.DataFrame({
            "ë‚ ì§œ": pd.to_datetime(data["daily"]["time"]),
            "ê°•ìˆ˜ í™•ë¥  (%)": data["daily"]["precipitation_probability_max"],
        })
    except Exception as e:
        st.error(f"ë‚ ì”¨ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜: {e}")
        return pd.DataFrame()


# -----------------------------------------------------------------
# 3) View ì „í™˜ ìƒíƒœ
# -----------------------------------------------------------------
def set_detail_view(chamber_id, chamber_no):
    st.session_state.view_mode = "detail"
    st.session_state.selected_chamber_id = chamber_id
    st.session_state.selected_chamber_no = chamber_no

def set_overview_view():
    st.session_state.view_mode = "overview"
    st.session_state.selected_chamber_id = None
    st.session_state.selected_chamber_no = None


# -----------------------------------------------------------------
# 4) ì•± ì„¤ì •/ì´ˆê¸° ë¡œë“œ
# -----------------------------------------------------------------
st.set_page_config(page_title="ğŸ· ìŠ¤ë§ˆíŠ¸ ì¶•ì‚¬ ëŒ€ì‹œë³´ë“œ", layout="wide")

if "view_mode" not in st.session_state:
    set_overview_view()

engine = init_db_connection()
sensor_df_all   = load_data_from_db(engine, "Chamber_Logs",   limit=20000)
pig_log_df_all  = load_data_from_db(engine, "Pig_Logs",       limit=None)
equipment_df_all= load_data_from_db(engine, "Equipment_Logs", limit=20000)
weather_df      = get_weather_forecast()
chambers_df     = load_data_from_db(engine, "Chambers",       limit=100, order_by_col=None)
pigs_df         = load_data_from_db(engine, "Pigs",           limit=5000, order_by_col=None)

# weight_kg ìˆ«ì ê°•ì œ
if not pig_log_df_all.empty and "weight_kg" in pig_log_df_all.columns:
    pig_log_df_all["weight_kg"] = pd.to_numeric(pig_log_df_all["weight_kg"], errors="coerce")


# =================================================================
# A) ì „ì²´ ë§µ (Overview)
# =================================================================
if st.session_state.view_mode == "overview":
    st.title("ğŸ· ìŠ¤ë§ˆíŠ¸ ì¶•ì‚¬ í˜„í™© (ì „ì²´ ë§µ)")

    # --- ì´ê´„ ìš”ì•½ ì„¹ì…˜ ---
    with st.container(border=True):
        st.subheader("AICU ì´ê´„ ìš”ì•½")
        cols = st.columns(5)

        # 1. 'Pigs' (ë§ˆìŠ¤í„° í…Œì´ë¸”) ê¸°ì¤€ ì´ ì‚¬ìœ¡ ë‘ìˆ˜
        total_pigs_with_logs = len(pig_log_df_all["pig_id"].unique()) if not pig_log_df_all.empty and "pig_id" in pig_log_df_all.columns else 0
        cols[0].metric("ì´ ì‚¬ìœ¡ ë‘ìˆ˜", f"{total_pigs_with_logs} ë§ˆë¦¬")

        # 2. 'ì£¼ì˜' ê°œì²´ ìˆ˜ ê³„ì‚°
        if not pig_log_df_all.empty and {"pig_id", "timestamp"}.issubset(pig_log_df_all.columns):
            # 2-1. ê° ë¼ì§€ì˜ 'ê°€ì¥ ìµœì‹ ' ë¡œê·¸ë§Œ ì¶”ì¶œ
            latest_pig_logs = pig_log_df_all.sort_values("timestamp").groupby("pig_id").tail(1)

            if {"temp_rectal", "breath_rate"}.issubset(latest_pig_logs.columns):
                # 2-2. (í•„í„°ë§) ìµœì‹  ë¡œê·¸ ì¤‘, ì²´ì˜¨>40 ë˜ëŠ” í˜¸í¡>50ì¸ ê°œì²´ë§Œ í•„í„°ë§
                warning_pigs = latest_pig_logs[
                    (latest_pig_logs["temp_rectal"] > 40) | (latest_pig_logs["breath_rate"] > 50)
                    ]

                # 2-3. (âœ… ìˆ˜ì • ì™„ë£Œ) 'ì£¼ì˜' ê°œì²´ë¡œ 'í•„í„°ë§ëœ' ìˆ«ì(len(warning_pigs))ë¥¼ ì¶œë ¥
                cols[1].metric("ì´ 'ì£¼ì˜' ê°œì²´ ìˆ˜", f"{len(warning_pigs)} ë§ˆë¦¬")
            else:
                cols[1].metric("ì´ 'ì£¼ì˜' ê°œì²´ ìˆ˜", "N/A (ë°ì´í„° ë¶€ì¡±)")
        else:
            cols[1].metric("ì´ 'ì£¼ì˜' ê°œì²´ ìˆ˜", "N/A (ë¡œê·¸ ì—†ìŒ)")

        if not sensor_df_all.empty and {"temperature","humidity"}.issubset(sensor_df_all.columns):
            cols[2].metric("ì „ì²´ í‰ê·  ì˜¨ë„", f"{sensor_df_all['temperature'].mean():.1f} Â°C")
            cols[3].metric("ì „ì²´ í‰ê·  ìŠµë„", f"{sensor_df_all['humidity'].mean():.1f} %")
        else:
            cols[2].metric("ì „ì²´ í‰ê·  ì˜¨ë„", "N/A")
            cols[3].metric("ì „ì²´ í‰ê·  ìŠµë„", "N/A")

        if not weather_df.empty:
            today_prob = weather_df.iloc[0]["ê°•ìˆ˜ í™•ë¥  (%)"]
            cols[4].metric("ì˜¤ëŠ˜ ê°•ìˆ˜ í™•ë¥ ", f"{today_prob:.0f} %")
            if today_prob > 70:
                st.warning("ğŸš¨ ê°•ìˆ˜ í™•ë¥ ì´ 70% ì´ìƒì…ë‹ˆë‹¤! í™˜ê¸°/ìŠµë„ ê´€ë¦¬ ìœ ì˜")
        else:
            cols[4].metric("ì˜¤ëŠ˜ ê°•ìˆ˜ í™•ë¥ ", "N/A")

    st.divider()
    st.subheader("ì±”ë²„ë³„ í˜„í™© (í´ë¦­í•˜ì—¬ ë“œë¦´ë‹¤ìš´)")

    if chambers_df.empty:
        st.info("ì±”ë²„ ì •ë³´ ì—†ìŒ")
    else:
        grid = st.columns(2)
        for i, row in chambers_df.iterrows():
            chamber_id = row.get("chamber_id", row.get("id", i))
            chamber_no = row.get("chamber_no", chamber_id)
            col = grid[i % 2]

            with col.container(border=True):
                st.subheader(f"âœ… {chamber_no}ë²ˆ ì±”ë²„")
                m1, m2 = st.columns(2)

                chamber_sensor = sensor_df_all[sensor_df_all.get("chamber_id", -1) == chamber_id]
                if not chamber_sensor.empty and "temperature" in chamber_sensor.columns:
                    cur_temp = float(chamber_sensor.sort_values("timestamp").tail(1)["temperature"].iloc[0])
                    m1.metric("í˜„ì¬ ì˜¨ë„", f"{cur_temp:.1f} Â°C")
                else:
                    m1.metric("í˜„ì¬ ì˜¨ë„", "N/A")

                if not pigs_df.empty and not pig_log_df_all.empty and "pig_id" in pigs_df.columns:
                    pigs_in = pigs_df[pigs_df.get("chamber_id", -1) == chamber_id]["pig_id"]
                    pig_logs_in = pig_log_df_all[pig_log_df_all["pig_id"].isin(pigs_in)]
                    if not pig_logs_in.empty and {"temp_rectal","breath_rate","timestamp"}.issubset(pig_logs_in.columns):
                        latest = pig_logs_in.sort_values("timestamp").groupby("pig_id").tail(1)
                        warn = latest[(latest["temp_rectal"] > 40) | (latest["breath_rate"] > 50)]
                        m2.metric("ê±´ê°• 'ì£¼ì˜' ê°œì²´", f"{len(warn)} ë§ˆë¦¬")
                    else:
                        m2.metric("ê±´ê°• 'ì£¼ì˜' ê°œì²´", "0 ë§ˆë¦¬")
                else:
                    m2.metric("ê±´ê°• 'ì£¼ì˜' ê°œì²´", "N/A")

                st.button(
                    f"{chamber_no}ë²ˆ ì±”ë²„ ìƒì„¸ ì •ë³´ ë³´ê¸°",
                    key=f"btn_detail_{chamber_id}",
                    on_click=set_detail_view,
                    args=(chamber_id, chamber_no),
                )


# =================================================================
# B) ì±”ë²„ ìƒì„¸ (Detail)
# =================================================================
elif st.session_state.view_mode == "detail":

    st.button("â—€ ì „ì²´ ë§µìœ¼ë¡œ ëŒì•„ê°€ê¸°", on_click=set_overview_view)
    selected_id = st.session_state.selected_chamber_id
    selected_no = st.session_state.selected_chamber_no
    st.title(f"ğŸ· {selected_no}ë²ˆ ì±”ë²„ ìƒì„¸ ì •ë³´")

    sensor_df_filtered    = sensor_df_all[sensor_df_all.get("chamber_id", -1) == selected_id]
    equipment_df_filtered = equipment_df_all[equipment_df_all.get("chamber_id", -1) == selected_id]

    if not pigs_df.empty and "pig_id" in pigs_df.columns:
        pigs_in_chamber = pigs_df[pigs_df.get("chamber_id", -1) == selected_id]["pig_id"]
        pig_log_df_filtered = pig_log_df_all[pig_log_df_all["pig_id"].isin(pigs_in_chamber)]
    else:
        pig_log_df_filtered = pd.DataFrame()

    st.divider()
    st.header("ğŸ“ˆ í˜„ì¬ ì±”ë²„ ìƒí™©")
    col1, col2 = st.columns(2)

    # ---------------- í™˜ê²½ ì„¼ì„œ (KPI + ê¸°ê°„ ìº˜ë¦°ë” + ê·¸ë˜í”„) ----------------
    with col1:
        st.subheader("ğŸ“Š í™˜ê²½ ì„¼ì„œ (Chamber_Logs)")
        needed = {"timestamp","temperature","humidity","co2"}
        if not sensor_df_filtered.empty and needed.issubset(sensor_df_filtered.columns):
            # ìµœê·¼ KPI 3ê°œ
            latest = sensor_df_filtered.sort_values("timestamp").tail(1).iloc[0]
            a, b, c = st.columns(3)
            a.metric("ì˜¨ë„", f"{latest['temperature']:.1f} Â°C")
            b.metric("ìŠµë„", f"{latest['humidity']:.1f} %")
            c.metric("COâ‚‚",  f"{latest['co2']:.0f} ppm")

            # âœ… ì—¬ê¸°! ì˜¨/ìŠµ/COâ‚‚ ë¼ì¸ ê·¸ë˜í”„ ìœ„ì— "ê¸°ê°„ ì„ íƒ" ìº˜ë¦°ë”
            dmin = pd.to_datetime(sensor_df_filtered["timestamp"].min()).date()
            dmax = pd.to_datetime(sensor_df_filtered["timestamp"].max()).date()

            date_range = st.date_input(
                "ê¸°ê°„ ì„ íƒ",
                value=(dmin, dmax),
                min_value=dmin,
                max_value=dmax,
                key=f"env_range_{selected_id}"
            )

            if isinstance(date_range, tuple) and len(date_range) == 2:
                start = pd.to_datetime(date_range[0])
                end   = pd.to_datetime(date_range[1]) + pd.Timedelta(days=1) - pd.Timedelta(seconds=1)
            else:
                start = pd.to_datetime(dmin)
                end   = pd.to_datetime(dmax)

            seg = sensor_df_filtered[
                (sensor_df_filtered["timestamp"] >= start) &
                (sensor_df_filtered["timestamp"] <= end)
            ].copy()

            if seg.empty:
                st.info("ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            else:
                t1, t2, t3 = st.tabs(["ğŸŒ¡ï¸ ì˜¨ë„", "ğŸ’§ ìŠµë„", "ğŸ’¨ COâ‚‚"])
                with t1:
                    st.line_chart(seg.set_index("timestamp")[["temperature"]])
                with t2:
                    st.line_chart(seg.set_index("timestamp")[["humidity"]])
                with t3:
                    st.line_chart(seg.set_index("timestamp")[["co2"]])
        else:
            st.warning("ì„¼ì„œ ë°ì´í„°(temperature/humidity/co2)ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")

    # ---------------- ë¼ì§€ ê±´ê°• ----------------
    with col2:
        st.subheader("â¤ï¸ ë¼ì§€ ê±´ê°• ìƒíƒœ (Pig_Logs)")
        if not pig_log_df_filtered.empty and {"pig_id","timestamp"}.issubset(pig_log_df_filtered.columns):
            latest = pig_log_df_filtered.sort_values("timestamp").groupby("pig_id").tail(1)
            warn = pd.DataFrame()
            if {"temp_rectal","breath_rate"}.issubset(latest.columns):
                warn = latest[(latest["temp_rectal"] > 40) | (latest["breath_rate"] > 50)]
            st.metric("ê±´ê°• 'ì£¼ì˜' ê°œì²´", f"{len(warn)} ë§ˆë¦¬")
            if len(warn) > 0:
                with st.expander("'ì£¼ì˜' ê°œì²´ ëª©ë¡ ë³´ê¸°"):
                    st.dataframe(warn[["pig_id","temp_rectal","breath_rate"]])
        else:
            st.info("ë¼ì§€ ë¡œê·¸ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")

    st.divider()

    # ---------------- ì¶œí•˜ ë° ì—ë„ˆì§€ ë¶„ì„ ----------------
    st.header("ğŸ– ì¶œí•˜ ë° ì—ë„ˆì§€ ë¶„ì„")
    tab1, tab2 = st.tabs(["ì¶œí•˜ ë‚ ì§œ ì˜ˆì¸¡", "ì—ë„ˆì§€ ì‚¬ìš©ëŸ‰ ë¶„ì„"])

    # âœ… ë„¤ê°€ ì¤€ 'ì¶œí•˜' ë¡œì§ ê·¸ëŒ€ë¡œ
    with tab1:
        target_weight = st.number_input(
            "ëª©í‘œ ì¶œí•˜ ì²´ì¤‘(kg)ì„ ì…ë ¥í•˜ì„¸ìš”:",
            min_value=80.0, value=80.0, step=1.0,
            help="ì´ ì²´ì¤‘ì„ ê¸°ì¤€ìœ¼ë¡œ ì¶œí•˜ ê°€ëŠ¥ ê°œì²´ ìˆ˜ì™€ ì˜ˆì¸¡ ë‚ ì§œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤."
        )

        if not pig_log_df_filtered.empty:
            logs_with_weights = (
                pig_log_df_filtered.dropna(subset=["weight_kg"])
                if "weight_kg" in pig_log_df_filtered.columns else pd.DataFrame()
            )

            if not logs_with_weights.empty:
                latest_weights = logs_with_weights.loc[
                    logs_with_weights.groupby("pig_id")["timestamp"].idxmax()
                ]

                ship_ready_now = latest_weights[latest_weights["weight_kg"] >= target_weight]

                c1, c2 = st.columns(2)
                c1.metric(f"í˜„ì¬ {target_weight}kg ì´ìƒ (ì¶œí•˜ ê°€ëŠ¥)", f"{len(ship_ready_now)} ë§ˆë¦¬")
                c2.metric("1ì£¼ì¼ ë‚´ ì¶œí•˜ ê°€ëŠ¥ (Mock)", f"{int(len(ship_ready_now) * 0.5) + 2} ë§ˆë¦¬ (Mock)")
                st.divider()

                st.subheader(f"ğŸ· {target_weight}kg ë„ë‹¬ ë‚ ì§œ ì˜ˆì¸¡ (AI Mock-up)")

                pigs_below = latest_weights[latest_weights["weight_kg"] < target_weight]
                if not pigs_below.empty:
                    rep = pigs_below.sort_values("weight_kg", ascending=False).iloc[0]
                    cur_w = rep["weight_kg"]
                    gap   = target_weight - cur_w
                    ADG   = 0.7  # ê°€ì •: ì¼ì¼ ì¦ì²´ëŸ‰
                    days  = gap / ADG
                    pred  = pd.Timestamp.now() + pd.Timedelta(days=days)

                    st.write(f"**ëŒ€í‘œ ê°œì²´ (Pig ID: {rep['pig_id']}) ë¶„ì„:**")
                    st.info(f"í˜„ì¬ {cur_w:.1f}kg â†’ {target_weight:.1f}kgê¹Œì§€ **ì•½ {days:.0f}ì¼** ì˜ˆìƒ")
                    st.metric(f"{target_weight}kg ì˜ˆìƒ ë„ë‹¬ ë‚ ì§œ", pred.strftime("%Y-%m-%d"))
                else:
                    st.success(f"ë°ì´í„°ê°€ ìˆëŠ” ëª¨ë“  ê°œì²´ê°€ ì´ë¯¸ ëª©í‘œ ì²´ì¤‘({target_weight}kg) ì´ìƒì…ë‹ˆë‹¤.")
            else:
                st.warning("ì´ ì±”ë²„ì—ëŠ” í˜„ì¬ ìœ íš¨í•œ ì²´ì¤‘ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            st.warning("ëª¸ë¬´ê²Œ ë°ì´í„°ê°€ ì—†ì–´ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    # âœ… ë„¤ê°€ ì¤€ 'ì—ë„ˆì§€' ë¡œì§ ê·¸ëŒ€ë¡œ
    with tab2:
        if not equipment_df_filtered.empty:
            total_usage = equipment_df_filtered.groupby("equipment_type")["power_usage_wh"].sum() / 1000.0
            st.bar_chart(total_usage.rename("ì´ ì‚¬ìš©ëŸ‰ (kWh)"))
        else:
            st.warning("ì—ë„ˆì§€ ì‚¬ìš©ëŸ‰ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

    st.divider()

    # ---------------- AI ì˜ˆì¸¡ (Mock) ----------------
    st.header("ğŸ¤– AI ì˜ˆì¸¡ ê²°ê³¼ (í˜„ì¬ ê°œë°œ ì¤‘)")

    def get_fake_prediction(features):
        return "ì •ìƒ ì¶œí•˜", 0.90

    if not sensor_df_filtered.empty and {"temperature","humidity"}.issubset(sensor_df_filtered.columns):
        latest_data = sensor_df_filtered.sort_values("timestamp").tail(1).iloc[0]
        pred, proba = get_fake_prediction({"temperature": latest_data["temperature"], "humidity": latest_data["humidity"]})
        s1, s2 = st.columns(2)
        s1.metric("ì˜ˆì¸¡ ê²°ê³¼", pred)
        s2.metric("ì •ìƒ í™•ë¥ ", f"{proba*100:.0f} %")
    else:
        st.info("ì„¼ì„œ ë°ì´í„°ê°€ ì—†ì–´ AI ì˜ˆì¸¡ UIë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")


# -----------------------------------------------------------------
# ë
# -----------------------------------------------------------------
st.caption("í”„ë¦¬ìº¡ìŠ¤í†¤ | í™˜ê²½ ì„¼ì„œ ì„¹ì…˜ì— ê¸°ê°„ ìº˜ë¦°ë” í¬í•¨ | ì¶œí•˜/ì—ë„ˆì§€ ë¶„ì„ì€ ì‚¬ìš©ì ë²„ì „ ê³ ì • | MySQL ì—°ë™ì€ secrets.tomlì´ ìˆì„ ë•Œ í™œì„±í™”")
